-- a. Create a table Films
CREATE TABLE Films(
    FID BIGINT PRIMARY KEY,
    TITLE VARCHAR(200) NOT NULL,
    PROD_YEAR BIGINT NOT NULL,
    RATING REAL NOT NULL CHECK (RATING BETWEEN 0 AND 10)
);



-- b. Create a table AnnualSummary
CREATE TABLE AnnualSummary (
    PROD_YEAR BIGINT NOT NULL PRIMARY KEY,
    FID BIGINT NOT NULL,
    RATED_ABOVE_8 BIGINT NOT NULL,
    FOREIGN KEY (FID) REFERENCES Films(FID)
);


-- c. Create a trigger AutoAddFID
GO
CREATE TRIGGER AutoAddFID
ON Films
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH next_id AS (
        SELECT COALESCE(MAX(FID), -1) + 1 AS start_id
        FROM Films
    ),
    ins AS (
        SELECT 
            ROW_NUMBER() OVER (ORDER BY (SELECT 1)) - 1 AS rn,
            TITLE, PROD_YEAR, RATING
        FROM inserted
    )
    INSERT INTO Films (FID, TITLE, PROD_YEAR, RATING)
    SELECT 
        n.start_id + i.rn,
        i.TITLE,
        i.PROD_YEAR,
        i.RATING
    FROM ins i 
    CROSS JOIN next_id n;
END
GO



-- d. Create a function GetBestFilm
GO
CREATE FUNCTION GetBestFilm (@P_YEAR BIGINT)
RETURNS BIGINT
AS
BEGIN
    DECLARE @BestFilmID BIGINT;

    SELECT TOP (1) @BestFilmID = FID
    FROM Films
    WHERE PROD_YEAR = @P_YEAR
    ORDER BY RATING DESC, FID ASC;

    RETURN @BestFilmID;
END
GO



-- e. Create a function GetNumAbove8
GO
CREATE FUNCTION GetNumAbove8 (@P_YEAR BIGINT)
RETURNS BIGINT
AS
BEGIN
    RETURN (
        SELECT COUNT(*)
        FROM Films
        WHERE PROD_YEAR = @P_YEAR
          AND RATING > 8
    );
END
GO



-- f. Create a procedure AddSummaryItems
GO
CREATE PROCEDURE AddSummaryItems
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO AnnualSummary (PROD_YEAR, FID, RATED_ABOVE_8)
    SELECT DISTINCT
        PROD_YEAR,
        GetBestFilm(PROD_YEAR),
        GetNumAbove8(PROD_YEAR)
    FROM Films;
END
GO
